<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ãƒ€ãƒ¼ãƒ“ãƒ¼ã‚¹ã‚¿ãƒªã‚ªãƒ³é¢¨ ç«¶é¦¬ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
  background: #1a1a2e;
  color: #e0e0e0;
  font-family: 'Segoe UI', 'Hiragino Sans', 'Noto Sans JP', sans-serif;
  min-height: 100vh;
  overflow-x: hidden;
}

#app {
  max-width: 800px;
  margin: 0 auto;
  padding: 16px;
}

h1 {
  text-align: center;
  font-size: 28px;
  color: #ffd700;
  margin: 16px 0;
  text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
}

h2 {
  font-size: 20px;
  color: #ffd700;
  margin-bottom: 12px;
  border-bottom: 2px solid #ffd700;
  padding-bottom: 4px;
}

.screen { display: none; }
.screen.active { display: block; }

/* ã‚«ãƒ¼ãƒ‰ */
.card {
  background: #16213e;
  border: 1px solid #0f3460;
  border-radius: 12px;
  padding: 16px;
  margin-bottom: 12px;
}

.card:hover { border-color: #ffd700; }

/* ãƒœã‚¿ãƒ³ */
.btn {
  display: inline-block;
  padding: 12px 24px;
  border: none;
  border-radius: 8px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.2s;
  text-align: center;
}

.btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
.btn:active { transform: translateY(0); }

.btn-primary { background: #ffd700; color: #1a1a2e; }
.btn-success { background: #27ae60; color: #fff; }
.btn-danger { background: #e74c3c; color: #fff; }
.btn-info { background: #3498db; color: #fff; }
.btn-secondary { background: #555; color: #fff; }
.btn-block { display: block; width: 100%; margin-top: 8px; }

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒãƒ¼ */
.stat-bar {
  display: flex;
  align-items: center;
  margin: 6px 0;
}

.stat-label {
  width: 80px;
  font-size: 14px;
  color: #aaa;
}

.stat-track {
  flex: 1;
  height: 16px;
  background: #0a0a1a;
  border-radius: 8px;
  overflow: hidden;
  margin: 0 8px;
}

.stat-fill {
  height: 100%;
  border-radius: 8px;
  transition: width 0.5s ease;
}

.stat-value {
  width: 40px;
  text-align: right;
  font-size: 14px;
  font-weight: bold;
}

.stat-speed .stat-fill { background: linear-gradient(90deg, #e74c3c, #ff6b6b); }
.stat-stamina .stat-fill { background: linear-gradient(90deg, #27ae60, #6bff6b); }
.stat-power .stat-fill { background: linear-gradient(90deg, #3498db, #6bb5ff); }
.stat-spirit .stat-fill { background: linear-gradient(90deg, #f39c12, #ffd700); }

/* é¦¬é¸æŠã‚°ãƒªãƒƒãƒ‰ */
.horse-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
}

@media (max-width: 500px) {
  .horse-grid { grid-template-columns: 1fr; }
}

.horse-card {
  cursor: pointer;
  transition: all 0.2s;
}

.horse-card:hover {
  border-color: #ffd700;
  transform: translateY(-2px);
  box-shadow: 0 4px 16px rgba(255, 215, 0, 0.2);
}

.horse-card .horse-emoji {
  font-size: 48px;
  text-align: center;
  margin-bottom: 8px;
}

.horse-card .horse-name {
  font-size: 18px;
  font-weight: bold;
  text-align: center;
  color: #ffd700;
  margin-bottom: 8px;
}

/* ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼ */
.training-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 12px;
  margin-bottom: 16px;
}

.training-card {
  cursor: pointer;
  text-align: center;
  transition: all 0.2s;
}

.training-card:hover {
  border-color: #ffd700;
  transform: translateY(-2px);
}

.training-card .training-icon { font-size: 36px; margin-bottom: 4px; }
.training-card .training-name { font-weight: bold; color: #ffd700; }
.training-card .training-desc { font-size: 12px; color: #aaa; margin-top: 4px; }

/* ãƒ¬ãƒ¼ã‚¹ç”»é¢ */
#race-canvas {
  width: 100%;
  height: 400px;
  background: #2d5a1b;
  border-radius: 12px;
  border: 3px solid #1a3a0a;
  margin-bottom: 12px;
}

/* ãƒ¬ãƒ¼ã‚¹æƒ…å ± */
.race-info {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
  flex-wrap: wrap;
  gap: 8px;
}

.race-info-item {
  background: #16213e;
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 14px;
}

.race-info-item span { color: #ffd700; font-weight: bold; }

/* çµæœç”»é¢ */
.result-table {
  width: 100%;
  border-collapse: collapse;
  margin: 12px 0;
}

.result-table th, .result-table td {
  padding: 10px;
  text-align: center;
  border-bottom: 1px solid #0f3460;
}

.result-table th {
  background: #0f3460;
  color: #ffd700;
}

.result-table tr:nth-child(even) { background: rgba(255,255,255,0.03); }
.result-table .rank-1 { color: #ffd700; font-weight: bold; }
.result-table .rank-2 { color: #c0c0c0; }
.result-table .rank-3 { color: #cd7f32; }

/* ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºãƒ˜ãƒƒãƒ€ãƒ¼ */
.header-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  background: #16213e;
  padding: 12px 16px;
  border-radius: 12px;
  margin-bottom: 16px;
  flex-wrap: wrap;
  gap: 8px;
}

.header-bar .info-chip {
  background: #0f3460;
  padding: 4px 12px;
  border-radius: 16px;
  font-size: 14px;
}

.header-bar .info-chip span { color: #ffd700; font-weight: bold; }

/* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

.screen.active { animation: fadeIn 0.3s ease; }

/* ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ */
.message-box {
  background: #0f3460;
  border-left: 4px solid #ffd700;
  padding: 12px 16px;
  border-radius: 0 8px 8px 0;
  margin: 12px 0;
  font-size: 14px;
  line-height: 1.6;
}

/* é€±ã®è¡¨ç¤º */
.week-display {
  text-align: center;
  font-size: 14px;
  color: #aaa;
  margin-bottom: 8px;
}

/* å®Ÿç¸¾ */
.trophy-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin: 8px 0;
}

.trophy {
  background: #0f3460;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 12px;
}

.trophy.won { background: #7a5c00; color: #ffd700; }

/* ç‰§å ´ç”»é¢ */
.farm-scene {
  text-align: center;
  font-size: 64px;
  padding: 20px;
  background: linear-gradient(180deg, #87CEEB 0%, #87CEEB 50%, #90EE90 50%, #228B22 100%);
  border-radius: 12px;
  margin-bottom: 16px;
  min-height: 120px;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 16px;
}

/* ãƒ¬ãƒ¼ã‚¹é¸æŠ */
.race-select-card {
  cursor: pointer;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.race-select-card .race-name {
  font-weight: bold;
  color: #ffd700;
  font-size: 16px;
}

.race-select-card .race-detail {
  font-size: 13px;
  color: #aaa;
  margin-top: 2px;
}

.race-grade {
  font-size: 14px;
  font-weight: bold;
  padding: 4px 10px;
  border-radius: 8px;
}

.grade-g1 { background: #7a5c00; color: #ffd700; }
.grade-g2 { background: #4a3a6a; color: #c0a0ff; }
.grade-g3 { background: #2a4a2a; color: #80e080; }
.grade-op { background: #333; color: #ccc; }

/* ã‚³ãƒ¡ãƒ³ãƒˆå¹ãå‡ºã— */
.comment-bubble {
  background: #fff;
  color: #333;
  padding: 12px 16px;
  border-radius: 16px;
  border-bottom-left-radius: 4px;
  margin: 12px 0;
  font-size: 14px;
  position: relative;
}

.comment-speaker {
  font-size: 12px;
  color: #888;
  margin-bottom: 4px;
}

/* ãƒ¬ãƒ¼ã‚¹å®Ÿæ³ãƒ†ã‚­ã‚¹ãƒˆ */
#race-commentary {
  background: #0a0a1a;
  color: #ffd700;
  padding: 10px 16px;
  border-radius: 8px;
  font-size: 14px;
  min-height: 40px;
  text-align: center;
  margin-bottom: 8px;
}

.condition-badge {
  display: inline-block;
  padding: 2px 8px;
  border-radius: 10px;
  font-size: 12px;
  margin-left: 8px;
}

.condition-good { background: #27ae60; color: #fff; }
.condition-normal { background: #f39c12; color: #fff; }
.condition-bad { background: #e74c3c; color: #fff; }
</style>
</head>
<body>
<div id="app">
  <h1>ğŸ‡ ãƒ€ãƒ¼ãƒ“ãƒ¼ã‚¹ã‚¿ãƒªã‚ªãƒ³ ğŸ‡</h1>

  <!-- ===== ã‚¿ã‚¤ãƒˆãƒ«ç”»é¢ ===== -->
  <div id="screen-title" class="screen active">
    <div class="farm-scene" style="font-size:80px; min-height:200px;">
      ğŸ´
    </div>
    <div class="card" style="text-align:center;">
      <p style="font-size:18px; margin-bottom:16px;">é¦¬ã‚’è‚²ã¦ã¦ã€æœ€å¼·ã®ãƒ€ãƒ¼ãƒ“ãƒ¼é¦¬ã‚’ç›®æŒ‡ã›ï¼</p>
      <button class="btn btn-primary btn-block" onclick="startGame()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
    </div>
  </div>

  <!-- ===== é¦¬é¸æŠç”»é¢ ===== -->
  <div id="screen-select" class="screen">
    <h2>ğŸ´ ä»”é¦¬ã‚’é¸ã¼ã†</h2>
    <p style="margin-bottom:12px; color:#aaa;">ç‰§å ´ã«4é ­ã®ä»”é¦¬ãŒç”Ÿã¾ã‚Œã¾ã—ãŸã€‚1é ­ã‚’é¸ã‚“ã§è‚²ã¦ã¾ã—ã‚‡ã†ã€‚</p>
    <div class="horse-grid" id="horse-grid"></div>
  </div>

  <!-- ===== ãƒ¡ã‚¤ãƒ³ï¼ˆè‚²æˆï¼‰ç”»é¢ ===== -->
  <div id="screen-main" class="screen">
    <div class="header-bar">
      <div class="info-chip">ğŸ—“ <span id="hud-year">3</span>æ­³ <span id="hud-month">4</span>æœˆ <span id="hud-week">1</span>é€±</div>
      <div class="info-chip">ğŸ’° <span id="hud-money">2000</span>ä¸‡å††</div>
      <div class="info-chip">ä½“èª¿: <span id="hud-condition">è‰¯å¥½</span></div>
    </div>

    <div class="card">
      <div style="display:flex; align-items:center; gap:12px; margin-bottom:8px;">
        <span style="font-size:48px;">ğŸ´</span>
        <div>
          <div style="font-size:20px; font-weight:bold; color:#ffd700;" id="main-horse-name"></div>
          <div style="font-size:13px; color:#aaa;" id="main-horse-type"></div>
        </div>
      </div>
      <div id="main-stats"></div>
      <div class="trophy-list" id="main-trophies"></div>
    </div>

    <div id="trainer-comment"></div>

    <h2 style="margin-top:16px;">ğŸ“‹ ä»Šé€±ã®è¡Œå‹•</h2>

    <div class="training-grid" id="training-menu"></div>

    <button class="btn btn-info btn-block" onclick="showRaceSelect()" id="btn-race">ğŸ ãƒ¬ãƒ¼ã‚¹ã«å‡ºèµ°ã™ã‚‹</button>
    <button class="btn btn-secondary btn-block" onclick="doRest()">ğŸ˜´ ä¼‘é¤Šã™ã‚‹</button>
  </div>

  <!-- ===== ãƒ¬ãƒ¼ã‚¹é¸æŠç”»é¢ ===== -->
  <div id="screen-race-select" class="screen">
    <h2>ğŸ å‡ºèµ°ãƒ¬ãƒ¼ã‚¹é¸æŠ</h2>
    <p style="margin-bottom:12px; color:#aaa;">ä»Šé€±å‡ºèµ°ã§ãã‚‹ãƒ¬ãƒ¼ã‚¹ã‚’é¸ã‚“ã§ãã ã•ã„ã€‚</p>
    <div id="race-list"></div>
    <button class="btn btn-secondary btn-block" onclick="showScreen('screen-main')" style="margin-top:12px;">æˆ»ã‚‹</button>
  </div>

  <!-- ===== ãƒ¬ãƒ¼ã‚¹ç”»é¢ ===== -->
  <div id="screen-race" class="screen">
    <div class="race-info" id="race-info-bar"></div>
    <div id="race-commentary">ãƒ¬ãƒ¼ã‚¹æº–å‚™ä¸­...</div>
    <canvas id="race-canvas"></canvas>
    <div id="race-controls" style="text-align:center;"></div>
  </div>

  <!-- ===== ãƒ¬ãƒ¼ã‚¹çµæœç”»é¢ ===== -->
  <div id="screen-result" class="screen">
    <h2 id="result-title">ğŸ† ãƒ¬ãƒ¼ã‚¹çµæœ</h2>
    <div id="result-message" class="message-box"></div>
    <table class="result-table" id="result-table">
      <thead><tr><th>ç€é †</th><th>é¦¬å</th><th>ã‚¿ã‚¤ãƒ </th></tr></thead>
      <tbody id="result-body"></tbody>
    </table>
    <div id="result-prize" style="text-align:center; margin:12px 0;"></div>
    <button class="btn btn-primary btn-block" onclick="afterRace()">æ¬¡ã®é€±ã¸</button>
  </div>

  <!-- ===== ã‚²ãƒ¼ãƒ çµ‚äº†ç”»é¢ ===== -->
  <div id="screen-ending" class="screen">
    <div class="farm-scene" style="min-height:160px;">ğŸ´ğŸ†</div>
    <h2 style="text-align:center;">å¼•é€€ - ã‚­ãƒ£ãƒªã‚¢æˆç¸¾</h2>
    <div class="card" id="ending-stats"></div>
    <div class="card" id="ending-trophies"></div>
    <button class="btn btn-primary btn-block" onclick="location.reload()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
  </div>
</div>

<script>
// ========== ã‚²ãƒ¼ãƒ å®šæ•° ==========
const HORSE_NAMES = [
  'ã‚µã‚¯ãƒ©ãƒ•ãƒ–ã‚­', 'ã‚¿ã‚±ã‚·ãƒã‚ªãƒ¼', 'ãƒŸãƒ›ãƒãƒ–ãƒ«ãƒœãƒ³', 'ãƒŠãƒªã‚¿ãƒ–ãƒ©ã‚¤ã‚¢ãƒ³',
  'ãƒˆã‚¦ã‚«ã‚¤ãƒ†ã‚¤ã‚ªãƒ¼', 'ã‚ªã‚°ãƒªã‚­ãƒ£ãƒƒãƒ—', 'ã‚·ãƒ³ãƒœãƒªãƒ«ãƒ‰ãƒ«ãƒ•', 'ãƒ†ã‚¤ã‚¨ãƒ ã‚ªãƒšãƒ©ã‚ªãƒ¼',
  'ãƒ‡ã‚£ãƒ¼ãƒ—ã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆ', 'ã‚­ã‚¿ã‚µãƒ³ãƒ–ãƒ©ãƒƒã‚¯', 'ã‚¨ãƒ«ã‚³ãƒ³ãƒ‰ãƒ«ãƒ‘ã‚µãƒ¼', 'ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚¦ã‚£ãƒ¼ã‚¯',
  'ãƒãƒ¤ãƒãƒˆãƒƒãƒ—ã‚¬ãƒ³', 'ã‚µã‚¤ãƒ¬ãƒ³ã‚¹ã‚¹ã‚ºã‚«', 'ã‚°ãƒ©ã‚¹ãƒ¯ãƒ³ãƒ€ãƒ¼', 'ã‚¦ã‚ªãƒƒã‚«',
  'ã‚´ãƒ¼ãƒ«ãƒ‰ã‚·ãƒƒãƒ—', 'ã‚¸ã‚§ãƒ³ãƒ†ã‚£ãƒ«ãƒ‰ãƒ³ãƒŠ', 'ãƒãƒ¼ãƒ„ã‚¯ãƒ©ã‚¤', 'ã‚¢ãƒ¼ãƒ¢ãƒ³ãƒ‰ã‚¢ã‚¤',
  'ã‚³ãƒ³ãƒˆãƒ¬ã‚¤ãƒ«', 'ã‚¤ã‚¯ã‚¤ãƒãƒƒã‚¯ã‚¹', 'ãƒªãƒãƒ†ã‚£ã‚¢ã‚¤ãƒ©ãƒ³ãƒ‰', 'ãƒ‰ã‚¥ãƒ©ãƒ¡ãƒ³ãƒ†'
];

const RIVAL_NAMES = [
  'ãƒ†ãƒ³ãƒã‚¦ãƒ¡', 'ã‚«ã‚¼ãƒãƒãƒ¤ãƒ†', 'ãƒ¤ãƒãƒˆãƒ€ãƒã‚·ã‚¤', 'ã‚¢ã‚ªã‚¾ãƒ©ãƒã‚«ã‚¼',
  'ãƒ›ã‚·ãƒã‚­ã‚»ã‚­', 'ãƒ©ã‚¤ã‚¸ãƒ³ã‚ªãƒ¼', 'ã‚«ãƒŸã‚«ã‚¼ãƒãƒ„ãƒã‚µ', 'ãƒ¦ãƒ¡ãƒãƒã‚«ãƒ©',
  'ãƒŸãƒ©ã‚¤ãƒãƒ›ã‚·', 'ãƒ€ã‚¤ãƒãƒã‚³ãƒ‰ã‚¦', 'ãƒãƒ«ã‚«ãƒŠãƒ«ã‚­ãƒœã‚¦', 'ãƒ•ã‚¦ã‚¦ãƒ³ã‚¸',
  'ã‚¢ã‚«ãƒ„ã‚­ãƒãƒ’ã‚«ãƒª', 'ã‚·ãƒãƒ“ãƒã‚«ã‚²', 'ã‚»ãƒ³ãƒ—ã‚¦ãƒãƒ«', 'ãƒ¬ãƒƒã‚«ãƒãƒ›ãƒã‚ª'
];

const HORSE_TYPES = [
  { name: 'ã‚¹ãƒ”ãƒ¼ãƒ‰å‹', desc: 'ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒä¼¸ã³ã‚„ã™ã„', bias: { speed: 1.4, stamina: 0.8, power: 1.0, spirit: 1.0 } },
  { name: 'ã‚¹ã‚¿ãƒŸãƒŠå‹', desc: 'ã‚¹ã‚¿ãƒŸãƒŠãŒä¼¸ã³ã‚„ã™ã„', bias: { speed: 0.9, stamina: 1.4, power: 1.0, spirit: 0.9 } },
  { name: 'ãƒ‘ãƒ¯ãƒ¼å‹', desc: 'ãƒ‘ãƒ¯ãƒ¼ãŒä¼¸ã³ã‚„ã™ã„', bias: { speed: 1.0, stamina: 1.0, power: 1.4, spirit: 0.8 } },
  { name: 'ãƒãƒ©ãƒ³ã‚¹å‹', desc: 'å…¨ä½“çš„ã«ãƒãƒ©ãƒ³ã‚¹ãŒè‰¯ã„', bias: { speed: 1.1, stamina: 1.1, power: 1.1, spirit: 1.1 } },
];

const TRAINING_MENU = [
  { id: 'speed', icon: 'ğŸ’¨', name: 'ã‚¹ãƒ”ãƒ¼ãƒ‰èµ°', desc: 'ã‚¹ãƒ”ãƒ¼ãƒ‰â†‘â†‘ ã‚¹ã‚¿ãƒŸãƒŠâ†‘', main: 'speed', sub: 'stamina', mainVal: 8, subVal: 3 },
  { id: 'stamina', icon: 'ğŸƒ', name: 'é•·è·é›¢èµ°', desc: 'ã‚¹ã‚¿ãƒŸãƒŠâ†‘â†‘ ãƒ‘ãƒ¯ãƒ¼â†‘', main: 'stamina', sub: 'power', mainVal: 8, subVal: 3 },
  { id: 'power', icon: 'ğŸ’ª', name: 'å‚è·¯èª¿æ•™', desc: 'ãƒ‘ãƒ¯ãƒ¼â†‘â†‘ ã‚¹ãƒ”ãƒ¼ãƒ‰â†‘', main: 'power', sub: 'speed', mainVal: 8, subVal: 3 },
  { id: 'spirit', icon: 'ğŸ”¥', name: 'ä½µã›é¦¬', desc: 'æ ¹æ€§â†‘â†‘ ãƒ‘ãƒ¯ãƒ¼â†‘', main: 'spirit', sub: 'power', mainVal: 8, subVal: 3 },
];

const RACE_SCHEDULE = [
  // 3æ­³
  { month: 6, week: 2, name: 'æ–°é¦¬æˆ¦', grade: 'OP', dist: 1600, prize: 300, minStat: 0 },
  { month: 7, week: 3, name: 'æœªå‹åˆ©æˆ¦', grade: 'OP', dist: 1800, prize: 300, minStat: 0 },
  { month: 9, week: 2, name: 'ã‚³ã‚¹ãƒ¢ã‚¹è³', grade: 'OP', dist: 1800, prize: 400, minStat: 100 },
  { month: 10, week: 2, name: 'äº¬éƒ½æ–°èæ¯', grade: 'G2', dist: 2200, prize: 600, minStat: 120 },
  { month: 11, week: 4, name: 'èŠèŠ±è³', grade: 'G1', dist: 3000, prize: 1500, minStat: 150 },
  { month: 12, week: 3, name: 'æœ‰é¦¬è¨˜å¿µ', grade: 'G1', dist: 2500, prize: 2000, minStat: 180 },
  // 4æ­³
  { month: 15, week: 1, name: 'äº¬éƒ½è¨˜å¿µ', grade: 'G2', dist: 2200, prize: 600, minStat: 160 },
  { month: 16, week: 3, name: 'å¤§é˜ªæ¯', grade: 'G1', dist: 2000, prize: 1500, minStat: 200 },
  { month: 17, week: 2, name: 'å¤©çš‡è³(æ˜¥)', grade: 'G1', dist: 3200, prize: 1800, minStat: 220 },
  { month: 18, week: 4, name: 'å®å¡šè¨˜å¿µ', grade: 'G1', dist: 2200, prize: 1800, minStat: 230 },
  { month: 21, week: 2, name: 'å¤©çš‡è³(ç§‹)', grade: 'G1', dist: 2000, prize: 1800, minStat: 250 },
  { month: 22, week: 3, name: 'ã‚¸ãƒ£ãƒ‘ãƒ³ã‚«ãƒƒãƒ—', grade: 'G1', dist: 2400, prize: 2500, minStat: 270 },
  { month: 23, week: 4, name: 'æœ‰é¦¬è¨˜å¿µ', grade: 'G1', dist: 2500, prize: 3000, minStat: 280 },
  // 5æ­³
  { month: 28, week: 3, name: 'å¤§é˜ªæ¯', grade: 'G1', dist: 2000, prize: 1500, minStat: 280 },
  { month: 29, week: 2, name: 'å¤©çš‡è³(æ˜¥)', grade: 'G1', dist: 3200, prize: 1800, minStat: 290 },
  { month: 30, week: 4, name: 'å®å¡šè¨˜å¿µ', grade: 'G1', dist: 2200, prize: 2000, minStat: 300 },
  { month: 33, week: 2, name: 'å¤©çš‡è³(ç§‹)', grade: 'G1', dist: 2000, prize: 2000, minStat: 310 },
  { month: 34, week: 3, name: 'ã‚¸ãƒ£ãƒ‘ãƒ³ã‚«ãƒƒãƒ—', grade: 'G1', dist: 2400, prize: 3000, minStat: 320 },
  { month: 35, week: 4, name: 'æœ‰é¦¬è¨˜å¿µ', grade: 'G1', dist: 2500, prize: 5000, minStat: 330 },
];

const TRAINER_COMMENTS = {
  start: [
    'ã“ã®é¦¬ã¯ã„ã„ç´ è³ªã‚’æŒã£ã¦ã„ã¾ã™ã‚ˆã€‚ã˜ã£ãã‚Šè‚²ã¦ã¾ã—ã‚‡ã†ã€‚',
    'ã¾ã è‹¥ã„ã§ã™ãŒã€å°†æ¥ãŒæ¥½ã—ã¿ãªé¦¬ã§ã™ã€‚',
    'ãªã‹ãªã‹ã®è¡€çµ±ã§ã™ã­ã€‚å¤§äº‹ã«è‚²ã¦ã¾ã—ã‚‡ã†ã€‚'
  ],
  speedUp: [
    'ã„ã„èµ°ã‚Šã‚’ã—ã¦ã„ã¾ã™ã­ï¼ã‚¹ãƒ”ãƒ¼ãƒ‰ãŒä¸ŠãŒã‚Šã¾ã—ãŸã€‚',
    'è„šãŒé€Ÿããªã£ã¦ã„ã¾ã™ã‚ˆã€‚ã“ã®èª¿å­ã§ã™ï¼',
  ],
  staminaUp: [
    'ã‚¹ã‚¿ãƒŸãƒŠãŒã¤ã„ã¦ãã¾ã—ãŸã­ã€‚é•·è·é›¢ã‚‚ã„ã‘ãã†ã§ã™ã€‚',
    'ç²˜ã‚Šå¼·ã•ãŒå‡ºã¦ãã¾ã—ãŸã€‚æˆé•·ã—ã¦ã„ã¾ã™ã‚ˆã€‚',
  ],
  powerUp: [
    'ãƒ‘ãƒ¯ãƒ¼ãŒã¤ã„ã¦ãã¾ã—ãŸã€‚å‚è·¯ã§ã‚‚åŠ›å¼·ã„èµ°ã‚Šã§ã™ã€‚',
    'é¦¬ä½“ãŒå……å®Ÿã—ã¦ãã¾ã—ãŸã­ã€‚ãƒ‘ãƒ¯ãƒ¼ãŒä¸ŠãŒã£ã¦ã„ã¾ã™ã€‚',
  ],
  spiritUp: [
    'é—˜å¿—ãŒã¿ãªãã£ã¦ã„ã¾ã™ã‚ˆï¼æ ¹æ€§ãŒã¤ãã¾ã—ãŸã€‚',
    'ç«¶ã‚Šåˆã„ã«å¼·ããªã£ã¦ãã¾ã—ãŸã­ã€‚',
  ],
  raceWin: [
    'ã‚„ã‚Šã¾ã—ãŸã­ï¼ç´ æ™´ã‚‰ã—ã„ãƒ¬ãƒ¼ã‚¹ã§ã—ãŸï¼',
    'åœ§å·»ã®èµ°ã‚Šã§ã—ãŸï¼æ¬¡ã®ãƒ¬ãƒ¼ã‚¹ã‚‚æœŸå¾…ã—ã¾ã—ã‚‡ã†ï¼',
    'è¦‹äº‹ãªå‹åˆ©ã§ã™ï¼ã“ã®é¦¬ã¯æœ¬ç‰©ã§ã™ã‚ˆï¼',
  ],
  raceLose: [
    'æ®‹å¿µã§ã—ãŸãŒã€ã„ã„çµŒé¨“ã«ãªã‚Šã¾ã—ãŸã€‚æ¬¡é ‘å¼µã‚Šã¾ã—ã‚‡ã†ã€‚',
    'ä»Šå›ã¯ç›¸æ‰‹ãŒå¼·ã‹ã£ãŸã§ã™ã­ã€‚ã¾ã ã¾ã ã“ã‚Œã‹ã‚‰ã§ã™ã€‚',
  ],
  tired: [
    'å°‘ã—ç–²ã‚ŒãŒè¦‹ãˆã¾ã™ã€‚ä¼‘é¤Šã‚‚å¤§äº‹ã§ã™ã‚ˆã€‚',
    'ä½“èª¿ãŒå¿ƒé…ã§ã™ã€‚ç„¡ç†ã¯ã•ã›ãªã„æ–¹ãŒã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚',
  ],
  rest: [
    'ã‚†ã£ãã‚Šä¼‘ã‚“ã§ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã—ã¾ã—ã‚‡ã†ã€‚',
    'ä¼‘é¤Šã§ä½“èª¿ãŒå›å¾©ã—ã¾ã—ãŸã‚ˆã€‚',
  ],
  conditionGood: [
    'ä»Šæ—¥ã¯èª¿å­ãŒã„ã„ã§ã™ã‚ˆï¼çµ¶å¥½èª¿ã§ã™ï¼',
    'ã‚³ãƒ³ãƒ‡ã‚£ã‚·ãƒ§ãƒ³æŠœç¾¤ã§ã™ï¼',
  ],
};

// ========== ã‚²ãƒ¼ãƒ çŠ¶æ…‹ ==========
let game = {
  horse: null,
  month: 4,  // 3æ­³4æœˆã‚¹ã‚¿ãƒ¼ãƒˆï¼ˆé€šç®—æœˆ: 4ï¼‰
  week: 1,
  money: 2000,
  condition: 80, // 0-100
  fatigue: 0,    // 0-100
  wins: 0,
  losses: 0,
  raceHistory: [],
  trophies: [],
};

// ========== ç”»é¢ç®¡ç† ==========
function showScreen(id) {
  document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}

// ========== ã‚²ãƒ¼ãƒ é–‹å§‹ ==========
function startGame() {
  showScreen('screen-select');
  generateHorses();
}

function generateHorses() {
  const grid = document.getElementById('horse-grid');
  grid.innerHTML = '';
  const names = shuffle([...HORSE_NAMES]).slice(0, 4);
  const types = shuffle([...HORSE_TYPES]);

  for (let i = 0; i < 4; i++) {
    const stats = {
      speed: randInt(25, 50),
      stamina: randInt(25, 50),
      power: randInt(25, 50),
      spirit: randInt(25, 50),
    };
    const horse = { name: names[i], type: types[i], stats };
    const card = document.createElement('div');
    card.className = 'card horse-card';
    card.innerHTML = `
      <div class="horse-emoji">ğŸ´</div>
      <div class="horse-name">${horse.name}</div>
      <div style="font-size:13px; color:#aaa; text-align:center; margin-bottom:8px;">${horse.type.name} - ${horse.type.desc}</div>
      ${renderStatBars(horse.stats)}
    `;
    card.onclick = () => selectHorse(horse);
    grid.appendChild(card);
  }
}

function selectHorse(horse) {
  game.horse = horse;
  game.month = 4;
  game.week = 1;
  game.money = 2000;
  game.condition = 80;
  game.fatigue = 0;
  game.wins = 0;
  game.losses = 0;
  game.raceHistory = [];
  game.trophies = [];
  showMainScreen();
  setTrainerComment(randPick(TRAINER_COMMENTS.start));
}

// ========== ãƒ¡ã‚¤ãƒ³ç”»é¢ ==========
function showMainScreen() {
  showScreen('screen-main');
  updateHUD();
  updateMainHorse();
  renderTrainingMenu();

  // å¼•é€€ãƒã‚§ãƒƒã‚¯ï¼ˆ5æ­³12æœˆã§å¼•é€€ï¼‰
  if (getAbsoluteMonth() > 36) {
    showEnding();
    return;
  }
}

function getAbsoluteMonth() {
  return game.month;
}

function getDisplayYear() {
  return Math.floor((game.month - 1) / 12) + 3;
}

function getDisplayMonth() {
  return ((game.month - 1) % 12) + 1;
}

function updateHUD() {
  document.getElementById('hud-year').textContent = getDisplayYear();
  document.getElementById('hud-month').textContent = getDisplayMonth();
  document.getElementById('hud-week').textContent = game.week;
  document.getElementById('hud-money').textContent = game.money;

  const condEl = document.getElementById('hud-condition');
  if (game.condition >= 70) {
    condEl.textContent = 'çµ¶å¥½èª¿';
    condEl.className = 'condition-badge condition-good';
  } else if (game.condition >= 40) {
    condEl.textContent = 'æ™®é€š';
    condEl.className = 'condition-badge condition-normal';
  } else {
    condEl.textContent = 'ä¸èª¿';
    condEl.className = 'condition-badge condition-bad';
  }
}

function updateMainHorse() {
  document.getElementById('main-horse-name').textContent = game.horse.name;
  document.getElementById('main-horse-type').textContent = `${game.horse.type.name} / æˆ¦ç¸¾: ${game.wins}å‹${game.losses}æ•—`;
  document.getElementById('main-stats').innerHTML = renderStatBars(game.horse.stats);

  const trophyEl = document.getElementById('main-trophies');
  if (game.trophies.length > 0) {
    trophyEl.innerHTML = game.trophies.map(t =>
      `<span class="trophy won">ğŸ† ${t}</span>`
    ).join('');
  } else {
    trophyEl.innerHTML = '<span class="trophy">ã¾ã å‹åˆ©ãªã—</span>';
  }
}

function renderStatBars(stats) {
  const entries = [
    { key: 'speed', label: 'ã‚¹ãƒ”ãƒ¼ãƒ‰', cls: 'stat-speed' },
    { key: 'stamina', label: 'ã‚¹ã‚¿ãƒŸãƒŠ', cls: 'stat-stamina' },
    { key: 'power', label: 'ãƒ‘ãƒ¯ãƒ¼', cls: 'stat-power' },
    { key: 'spirit', label: 'æ ¹æ€§', cls: 'stat-spirit' },
  ];
  return entries.map(e => {
    const val = Math.min(stats[e.key], 400);
    const pct = Math.min((val / 400) * 100, 100);
    return `
      <div class="stat-bar ${e.cls}">
        <span class="stat-label">${e.label}</span>
        <div class="stat-track"><div class="stat-fill" style="width:${pct}%"></div></div>
        <span class="stat-value">${stats[e.key]}</span>
      </div>`;
  }).join('');
}

function renderTrainingMenu() {
  const menu = document.getElementById('training-menu');
  menu.innerHTML = TRAINING_MENU.map(t => `
    <div class="card training-card" onclick="doTraining('${t.id}')">
      <div class="training-icon">${t.icon}</div>
      <div class="training-name">${t.name}</div>
      <div class="training-desc">${t.desc}</div>
    </div>
  `).join('');
}

// ========== ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚° ==========
function doTraining(type) {
  const tr = TRAINING_MENU.find(t => t.id === type);
  if (!tr) return;

  const bias = game.horse.type.bias;
  const condMult = game.condition >= 70 ? 1.2 : game.condition >= 40 ? 1.0 : 0.7;
  const randomBonus = randInt(-2, 4);

  const mainGain = Math.round(tr.mainVal * bias[tr.main] * condMult) + randomBonus;
  const subGain = Math.round(tr.subVal * bias[tr.sub] * condMult) + Math.max(0, randInt(-1, 2));

  game.horse.stats[tr.main] = Math.min(400, game.horse.stats[tr.main] + Math.max(1, mainGain));
  game.horse.stats[tr.sub] = Math.min(400, game.horse.stats[tr.sub] + Math.max(1, subGain));

  // ç–²åŠ´è“„ç©
  game.fatigue = Math.min(100, game.fatigue + randInt(8, 15));
  game.condition = Math.max(10, game.condition - randInt(3, 8));

  // ç¨€ã«æ€ªæˆ‘
  if (game.fatigue > 80 && Math.random() < 0.15) {
    game.condition = Math.max(10, game.condition - 20);
    setTrainerComment('âš ï¸ ãƒˆãƒ¬ãƒ¼ãƒ‹ãƒ³ã‚°ä¸­ã«è»½ã„æ•…éšœãŒâ€¦ã€‚å°‘ã—ä¼‘ã¾ã›ãŸæ–¹ãŒã„ã„ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ã€‚');
  } else {
    const commentKey = tr.main + 'Up';
    const comments = TRAINER_COMMENTS[commentKey] || TRAINER_COMMENTS.speedUp;
    setTrainerComment(randPick(comments) + ` (${tr.main === 'speed' ? 'ã‚¹ãƒ”ãƒ¼ãƒ‰' : tr.main === 'stamina' ? 'ã‚¹ã‚¿ãƒŸãƒŠ' : tr.main === 'power' ? 'ãƒ‘ãƒ¯ãƒ¼' : 'æ ¹æ€§'}+${mainGain})`);
  }

  advanceWeek();
}

function doRest() {
  const recover = randInt(15, 30);
  game.condition = Math.min(100, game.condition + recover);
  game.fatigue = Math.max(0, game.fatigue - randInt(20, 40));
  setTrainerComment(randPick(TRAINER_COMMENTS.rest));
  advanceWeek();
}

function advanceWeek() {
  game.week++;
  if (game.week > 4) {
    game.week = 1;
    game.month++;
  }
  // è‡ªç„¶å›å¾©
  game.condition = Math.min(100, game.condition + randInt(1, 3));
  game.fatigue = Math.max(0, game.fatigue - randInt(2, 5));

  showMainScreen();
}

// ========== ãƒˆãƒ¬ãƒ¼ãƒŠãƒ¼ã‚³ãƒ¡ãƒ³ãƒˆ ==========
function setTrainerComment(text) {
  const el = document.getElementById('trainer-comment');
  el.innerHTML = `
    <div class="comment-bubble">
      <div class="comment-speaker">ğŸ§‘â€ğŸŒ¾ èª¿æ•™å¸«</div>
      ${text}
    </div>
  `;
}

// ========== ãƒ¬ãƒ¼ã‚¹é¸æŠ ==========
function showRaceSelect() {
  showScreen('screen-race-select');
  const list = document.getElementById('race-list');
  const absMonth = getAbsoluteMonth();

  // ç¾åœ¨ã®æœˆÂ±1ãƒ¶æœˆã®ãƒ¬ãƒ¼ã‚¹ã‚’è¡¨ç¤º
  const available = RACE_SCHEDULE.filter(r => {
    return r.month === absMonth || (r.month === absMonth && r.week >= game.week) || (r.month === absMonth + 1);
  });

  // å¸¸ã«ã‚ªãƒ¼ãƒ—ãƒ³æˆ¦ã‚’è¿½åŠ 
  const totalStat = game.horse.stats.speed + game.horse.stats.stamina + game.horse.stats.power + game.horse.stats.spirit;
  const openRaces = [
    { name: 'ã‚ªãƒ¼ãƒ—ãƒ³æˆ¦ (1600m)', grade: 'OP', dist: 1600, prize: 200 + Math.floor(totalStat / 2), minStat: 0, month: absMonth, week: game.week },
    { name: 'ã‚ªãƒ¼ãƒ—ãƒ³æˆ¦ (2000m)', grade: 'OP', dist: 2000, prize: 250 + Math.floor(totalStat / 2), minStat: 0, month: absMonth, week: game.week },
    { name: 'ã‚ªãƒ¼ãƒ—ãƒ³æˆ¦ (2400m)', grade: 'OP', dist: 2400, prize: 300 + Math.floor(totalStat / 2), minStat: 0, month: absMonth, week: game.week },
  ];

  const allRaces = [...available, ...openRaces];

  if (allRaces.length === 0) {
    list.innerHTML = '<div class="message-box">ä»Šå‡ºèµ°ã§ãã‚‹ãƒ¬ãƒ¼ã‚¹ãŒã‚ã‚Šã¾ã›ã‚“ã€‚</div>';
    return;
  }

  list.innerHTML = allRaces.map((r, i) => {
    const gradeClass = r.grade === 'G1' ? 'grade-g1' : r.grade === 'G2' ? 'grade-g2' : r.grade === 'G3' ? 'grade-g3' : 'grade-op';
    return `
      <div class="card race-select-card" onclick="enterRace(${i})" data-race-idx="${i}">
        <div>
          <div class="race-name">${r.name}</div>
          <div class="race-detail">${r.dist}m / è³é‡‘ ${r.prize}ä¸‡å††</div>
        </div>
        <span class="race-grade ${gradeClass}">${r.grade}</span>
      </div>
    `;
  }).join('');

  // ãƒ¬ãƒ¼ã‚¹ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜
  window._availableRaces = allRaces;
}

// ========== ãƒ¬ãƒ¼ã‚¹ ==========
let raceState = null;

function enterRace(idx) {
  const race = window._availableRaces[idx];
  if (!race) return;

  raceState = {
    race,
    runners: generateRunners(race),
    positions: [],
    frame: 0,
    finished: false,
    results: null,
  };

  showScreen('screen-race');

  // ãƒ¬ãƒ¼ã‚¹æƒ…å ±ãƒãƒ¼
  const gradeClass = race.grade === 'G1' ? 'grade-g1' : race.grade === 'G2' ? 'grade-g2' : race.grade === 'G3' ? 'grade-g3' : 'grade-op';
  document.getElementById('race-info-bar').innerHTML = `
    <div class="race-info-item"><span class="race-grade ${gradeClass}">${race.grade}</span> ${race.name}</div>
    <div class="race-info-item">è·é›¢: <span>${race.dist}m</span></div>
    <div class="race-info-item">è³é‡‘: <span>${race.prize}ä¸‡å††</span></div>
  `;

  document.getElementById('race-controls').innerHTML = '';
  document.getElementById('race-commentary').textContent = 'ã‚²ãƒ¼ãƒˆã‚¤ãƒ³...';

  setTimeout(() => {
    document.getElementById('race-commentary').textContent = 'ã‚¹ã‚¿ãƒ¼ãƒˆï¼ï¼';
    startRaceAnimation();
  }, 1500);
}

function generateRunners(race) {
  const runners = [];
  const totalStat = game.horse.stats.speed + game.horse.stats.stamina + game.horse.stats.power + game.horse.stats.spirit;
  const condMult = game.condition >= 70 ? 1.05 : game.condition >= 40 ? 1.0 : 0.9;

  // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®é¦¬
  runners.push({
    name: game.horse.name,
    isPlayer: true,
    speed: game.horse.stats.speed * condMult,
    stamina: game.horse.stats.stamina * condMult,
    power: game.horse.stats.power * condMult,
    spirit: game.horse.stats.spirit * condMult,
    color: '#ffd700',
    pos: 0,
    finished: false,
    time: 0,
  });

  // ãƒ©ã‚¤ãƒãƒ«é¦¬(7é ­)
  const rivalNames = shuffle([...RIVAL_NAMES]).slice(0, 7);
  const colors = ['#ff6b6b', '#6bff6b', '#6bb5ff', '#ff6bff', '#ffaa6b', '#6bffff', '#ff6baa'];

  for (let i = 0; i < 7; i++) {
    // ãƒ©ã‚¤ãƒãƒ«ã®å¼·ã•ã¯ãƒ¬ãƒ¼ã‚¹ã®æœ€ä½ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’åŸºæº–ã«ã°ã‚‰ã¤ãã‚’æŒãŸã›ã‚‹
    const base = race.minStat > 0 ? race.minStat * 0.8 : totalStat * 0.6;
    const variance = race.grade === 'G1' ? 0.3 : race.grade === 'G2' ? 0.35 : 0.4;
    const mult = 0.7 + Math.random() * variance + (race.grade === 'G1' ? 0.3 : race.grade === 'G2' ? 0.2 : 0.1);

    const rivalTotal = Math.max(base * mult, 60);
    runners.push({
      name: rivalNames[i],
      isPlayer: false,
      speed: rivalTotal * (0.8 + Math.random() * 0.4),
      stamina: rivalTotal * (0.8 + Math.random() * 0.4),
      power: rivalTotal * (0.8 + Math.random() * 0.4),
      spirit: rivalTotal * (0.8 + Math.random() * 0.4),
      color: colors[i],
      pos: 0,
      finished: false,
      time: 0,
    });
  }

  return runners;
}

function startRaceAnimation() {
  const canvas = document.getElementById('race-canvas');
  const ctx = canvas.getContext('2d');
  canvas.width = canvas.clientWidth * 2;
  canvas.height = canvas.clientHeight * 2;
  ctx.scale(2, 2);

  const W = canvas.clientWidth;
  const H = canvas.clientHeight;
  const dist = raceState.race.dist;
  const totalFrames = 300 + dist / 20;
  const laneH = H / (raceState.runners.length + 1);
  let finishCount = 0;

  const commentaryEvents = [
    { at: 0.1, text: 'ã‚¹ã‚¿ãƒ¼ãƒˆã—ã¾ã—ãŸï¼å„é¦¬ä¸€æ–‰ã«ãƒ€ãƒƒã‚·ãƒ¥ï¼' },
    { at: 0.25, text: 'ç¬¬1ã‚³ãƒ¼ãƒŠãƒ¼ã‚’å›ã‚Šã¾ã™ï¼' },
    { at: 0.4, text: 'å‘ã“ã†æ­£é¢ã«å…¥ã‚Šã¾ã—ãŸã€‚å„é¦¬å›ºã¾ã£ã¦ã„ã¾ã™ã€‚' },
    { at: 0.55, text: 'ç¬¬3ã‚³ãƒ¼ãƒŠãƒ¼ã‚’å›ã£ã¦æ®‹ã‚Š800mï¼' },
    { at: 0.7, text: 'æœ€çµ‚ã‚³ãƒ¼ãƒŠãƒ¼ã‚’å›ã£ã¦ç›´ç·šã«å…¥ã‚Šã¾ã™ï¼' },
    { at: 0.85, text: 'æ®‹ã‚Š200mï¼å„é¦¬å¿…æ­»ã®è¿½ã„æ¯”ã¹ï¼' },
  ];
  let nextComment = 0;

  function animate() {
    raceState.frame++;
    const progress = raceState.frame / totalFrames;

    // å®Ÿæ³
    if (nextComment < commentaryEvents.length && progress >= commentaryEvents[nextComment].at) {
      let text = commentaryEvents[nextComment].text;
      // å…ˆé ­ã®é¦¬åã‚’è¿½åŠ 
      const sorted = [...raceState.runners].sort((a, b) => b.pos - a.pos);
      if (progress > 0.3) {
        text += ` å…ˆé ­ã¯${sorted[0].name}ï¼`;
      }
      document.getElementById('race-commentary').textContent = text;
      nextComment++;
    }

    // å„é¦¬ã®ä½ç½®æ›´æ–°
    for (const runner of raceState.runners) {
      if (runner.finished) continue;

      const speedFactor = runner.speed / 300;
      const staminaFactor = runner.stamina / 300;
      const powerFactor = runner.power / 400;
      const spiritFactor = runner.spirit / 400;

      // åºç›¤ã¯ã‚¹ãƒ”ãƒ¼ãƒ‰é‡è¦–ã€ä¸­ç›¤ã¯ã‚¹ã‚¿ãƒŸãƒŠã€çµ‚ç›¤ã¯ãƒ‘ãƒ¯ãƒ¼+æ ¹æ€§
      let accel;
      if (progress < 0.3) {
        accel = 0.5 + speedFactor * 0.8 + Math.random() * 0.3;
      } else if (progress < 0.7) {
        accel = 0.4 + staminaFactor * 0.6 + speedFactor * 0.3 + Math.random() * 0.2;
      } else {
        accel = 0.3 + powerFactor * 0.7 + spiritFactor * 0.5 + speedFactor * 0.2 + Math.random() * 0.25;
        // æ ¹æ€§è£œæ­£: æ¥æˆ¦ã»ã©ç™ºå‹•
        const sorted = [...raceState.runners].sort((a, b) => b.pos - a.pos);
        const lead = sorted[0].pos;
        if (lead - runner.pos < W * 0.1) {
          accel += spiritFactor * 0.3;
        }
      }

      runner.pos += accel;
      runner.time = raceState.frame;

      if (runner.pos >= W - 60) {
        runner.pos = W - 60;
        runner.finished = true;
        finishCount++;
      }
    }

    // æç”»
    ctx.clearRect(0, 0, W, H);

    // èŠ
    ctx.fillStyle = '#2d5a1b';
    ctx.fillRect(0, 0, W, H);

    // ãƒ¬ãƒ¼ãƒ³
    for (let i = 0; i < raceState.runners.length; i++) {
      const y = laneH * (i + 0.5);
      // ãƒ¬ãƒ¼ãƒ³ç·š
      ctx.strokeStyle = 'rgba(255,255,255,0.15)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(0, y + laneH * 0.4);
      ctx.lineTo(W, y + laneH * 0.4);
      ctx.stroke();
    }

    // ã‚´ãƒ¼ãƒ«ãƒ©ã‚¤ãƒ³
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 3;
    ctx.setLineDash([6, 4]);
    ctx.beginPath();
    ctx.moveTo(W - 60, 0);
    ctx.lineTo(W - 60, H);
    ctx.stroke();
    ctx.setLineDash([]);

    // ã‚´ãƒ¼ãƒ«ãƒ†ã‚­ã‚¹ãƒˆ
    ctx.fillStyle = '#fff';
    ctx.font = 'bold 12px sans-serif';
    ctx.textAlign = 'center';
    ctx.fillText('GOAL', W - 60, 14);

    // é¦¬ã‚’æç”»
    for (let i = 0; i < raceState.runners.length; i++) {
      const runner = raceState.runners[i];
      const y = laneH * (i + 0.5);
      const x = Math.max(10, runner.pos);

      // é¦¬ä½“
      ctx.font = `${Math.min(laneH * 0.7, 28)}px serif`;
      ctx.textAlign = 'center';
      ctx.fillText('ğŸ‡', x, y + laneH * 0.15);

      // åå‰
      ctx.font = `bold ${Math.min(laneH * 0.3, 11)}px sans-serif`;
      ctx.fillStyle = runner.isPlayer ? '#ffd700' : '#ddd';
      ctx.fillText(runner.name, x, y + laneH * 0.35);

      // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒãƒ¼ã‚«ãƒ¼
      if (runner.isPlayer) {
        ctx.fillStyle = '#ffd700';
        ctx.font = `bold ${Math.min(laneH * 0.25, 10)}px sans-serif`;
        ctx.fillText('â–¼', x, y - laneH * 0.25);
      }
    }

    // å…¨é¦¬ã‚´ãƒ¼ãƒ«ã¾ãŸã¯ãƒ•ãƒ¬ãƒ¼ãƒ ä¸Šé™
    if (finishCount >= raceState.runners.length || raceState.frame > totalFrames + 100) {
      // æœªã‚´ãƒ¼ãƒ«ã®é¦¬ã‚’å¼·åˆ¶ãƒ•ã‚£ãƒ‹ãƒƒã‚·ãƒ¥
      for (const r of raceState.runners) {
        if (!r.finished) { r.finished = true; r.time = raceState.frame; }
      }
      raceState.finished = true;
      showRaceResult();
      return;
    }

    requestAnimationFrame(animate);
  }

  requestAnimationFrame(animate);
}

function showRaceResult() {
  const sorted = [...raceState.runners].sort((a, b) => a.time - b.time || (b.pos - a.pos));
  const playerRank = sorted.findIndex(r => r.isPlayer) + 1;
  const race = raceState.race;

  // ã‚¿ã‚¤ãƒ è¨ˆç®—
  const baseTime = race.dist / 1000 * 60; // åŸºæº–ã‚¿ã‚¤ãƒ (ç§’)
  sorted.forEach((r, i) => {
    const timeSec = baseTime + (r.time - sorted[0].time) * 0.05 + Math.random() * 0.3;
    const min = Math.floor(timeSec / 60);
    const sec = (timeSec % 60).toFixed(1);
    r.displayTime = `${min}:${sec.padStart(4, '0')}`;
  });

  // çµæœç”»é¢
  showScreen('screen-result');

  if (playerRank === 1) {
    document.getElementById('result-title').textContent = 'ğŸ† 1ç€ï¼ãŠã‚ã§ã¨ã†ï¼ ğŸ†';
    document.getElementById('result-message').innerHTML = `
      <strong>${game.horse.name}</strong>ãŒè¦‹äº‹1ç€ã§ã‚´ãƒ¼ãƒ«ï¼<br>
      ${randPick(TRAINER_COMMENTS.raceWin)}
    `;
    document.getElementById('result-prize').innerHTML = `<span style="font-size:24px; color:#ffd700;">è³é‡‘ ${race.prize}ä¸‡å†† ç²å¾—ï¼</span>`;
    game.money += race.prize;
    game.wins++;
    game.trophies.push(`${race.name}(${race.grade})`);
  } else if (playerRank <= 3) {
    const prizes = [0, race.prize, Math.floor(race.prize * 0.4), Math.floor(race.prize * 0.2)];
    const p = prizes[playerRank];
    document.getElementById('result-title').textContent = `${playerRank}ç€ï¼æƒœã—ã„ï¼`;
    document.getElementById('result-message').innerHTML = `
      <strong>${game.horse.name}</strong>ã¯${playerRank}ç€ã§ã—ãŸã€‚<br>
      ${randPick(TRAINER_COMMENTS.raceLose)}
    `;
    document.getElementById('result-prize').innerHTML = `<span style="font-size:20px; color:#c0c0c0;">è³é‡‘ ${p}ä¸‡å†† ç²å¾—</span>`;
    game.money += p;
    game.losses++;
  } else {
    document.getElementById('result-title').textContent = `${playerRank}ç€...`;
    document.getElementById('result-message').innerHTML = `
      <strong>${game.horse.name}</strong>ã¯${playerRank}ç€ã§ã—ãŸã€‚<br>
      ${randPick(TRAINER_COMMENTS.raceLose)}
    `;
    document.getElementById('result-prize').innerHTML = '';
    game.losses++;
  }

  game.raceHistory.push({ name: race.name, grade: race.grade, rank: playerRank });

  // ãƒ¬ãƒ¼ã‚¹å¾Œã®ç–²åŠ´
  game.fatigue = Math.min(100, game.fatigue + randInt(15, 30));
  game.condition = Math.max(10, game.condition - randInt(5, 15));

  // ãƒ¬ãƒ¼ã‚¹çµŒé¨“ã§ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å¾®å¢—
  game.horse.stats.speed = Math.min(400, game.horse.stats.speed + randInt(1, 3));
  game.horse.stats.spirit = Math.min(400, game.horse.stats.spirit + randInt(1, 4));

  // çµæœãƒ†ãƒ¼ãƒ–ãƒ«
  const tbody = document.getElementById('result-body');
  tbody.innerHTML = sorted.map((r, i) => {
    const rank = i + 1;
    const cls = rank === 1 ? 'rank-1' : rank === 2 ? 'rank-2' : rank === 3 ? 'rank-3' : '';
    const marker = r.isPlayer ? ' â—€' : '';
    return `<tr class="${cls}"><td>${rank}</td><td>${r.name}${marker}</td><td>${r.displayTime}</td></tr>`;
  }).join('');
}

function afterRace() {
  advanceWeek();
}

// ========== ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚° ==========
function showEnding() {
  showScreen('screen-ending');

  const totalPrize = game.money;
  const g1Wins = game.trophies.filter(t => t.includes('G1')).length;
  const g2Wins = game.trophies.filter(t => t.includes('G2')).length;

  let rank = 'å¹³å‡¡ãªç«¶èµ°é¦¬';
  if (g1Wins >= 5) rank = 'ä¼èª¬ã®åé¦¬ ğŸŒŸğŸŒŸğŸŒŸ';
  else if (g1Wins >= 3) rank = 'æ­´å²çš„åé¦¬ ğŸŒŸğŸŒŸ';
  else if (g1Wins >= 1) rank = 'G1ãƒ›ãƒ¼ã‚¹ ğŸŒŸ';
  else if (game.wins >= 5) rank = 'é‡è³ã‚¦ã‚£ãƒŠãƒ¼';
  else if (game.wins >= 1) rank = 'å‹ã¡ä¸ŠãŒã‚Šé¦¬';

  document.getElementById('ending-stats').innerHTML = `
    <div style="text-align:center; margin-bottom:12px;">
      <span style="font-size:48px;">ğŸ´</span>
      <div style="font-size:24px; color:#ffd700; font-weight:bold;">${game.horse.name}</div>
      <div style="font-size:18px; color:#aaa;">${rank}</div>
    </div>
    ${renderStatBars(game.horse.stats)}
    <div style="margin-top:12px; display:flex; justify-content:space-around; text-align:center;">
      <div><div style="font-size:24px; color:#ffd700;">${game.wins}</div><div style="font-size:12px; color:#aaa;">å‹åˆ©</div></div>
      <div><div style="font-size:24px; color:#aaa;">${game.losses}</div><div style="font-size:12px; color:#aaa;">æ•—åŒ—</div></div>
      <div><div style="font-size:24px; color:#ffd700;">${g1Wins}</div><div style="font-size:12px; color:#aaa;">G1å‹åˆ©</div></div>
      <div><div style="font-size:24px; color:#27ae60;">${totalPrize}</div><div style="font-size:12px; color:#aaa;">ç²å¾—è³é‡‘(ä¸‡)</div></div>
    </div>
  `;

  document.getElementById('ending-trophies').innerHTML = `
    <h3 style="color:#ffd700; margin-bottom:8px;">ğŸ† ç²å¾—ã‚¿ã‚¤ãƒˆãƒ«</h3>
    ${game.trophies.length > 0
      ? game.trophies.map(t => `<span class="trophy won">ğŸ† ${t}</span>`).join(' ')
      : '<span style="color:#aaa;">ã‚¿ã‚¤ãƒˆãƒ«ãªã—</span>'
    }
  `;
}

// ========== ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ ==========
function randInt(min, max) {
  return Math.floor(Math.random() * (max - min + 1)) + min;
}

function randPick(arr) {
  return arr[Math.floor(Math.random() * arr.length)];
}

function shuffle(arr) {
  for (let i = arr.length - 1; i > 0; i--) {
    const j = Math.floor(Math.random() * (i + 1));
    [arr[i], arr[j]] = [arr[j], arr[i]];
  }
  return arr;
}
</script>
</body>
</html>
